!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/forms"),require("@angular/router"),require("@biesbjerg/ngx-translate-extract-marker"),require("@vendure/admin-ui/core"),require("rxjs/operators"),require("rxjs")):"function"==typeof define&&define.amd?define("@vendure/admin-ui/marketing",["exports","@angular/core","@angular/forms","@angular/router","@biesbjerg/ngx-translate-extract-marker","@vendure/admin-ui/core","rxjs/operators","rxjs"],t):t(((n="undefined"!=typeof globalThis?globalThis:n||self).vendure=n.vendure||{},n.vendure["admin-ui"]=n.vendure["admin-ui"]||{},n.vendure["admin-ui"].marketing={}),n.ng.core,n.ng.forms,n.ng.router,n.ngxTranslateExtractMarker,n.vendure["admin-ui"].core,n.rxjs.operators,n.rxjs)}(this,(function(n,t,o,e,r,i,a,d){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var c=function(n,t){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(n[o]=t[o])})(n,t)};function s(n,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function o(){this.constructor=n}c(n,t),n.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}Object.create;function l(n,t){var o="function"==typeof Symbol&&n[Symbol.iterator];if(!o)return n;var e,r,i=o.call(n),a=[];try{for(;(void 0===t||t-- >0)&&!(e=i.next()).done;)a.push(e.value)}catch(n){r={error:n}}finally{try{e&&!e.done&&(o=i.return)&&o.call(i)}finally{if(r)throw r.error}}return a}function m(){for(var n=[],t=0;t<arguments.length;t++)n=n.concat(l(arguments[t]));return n}Object.create;var u=function(n){function t(t,e,r,i,a,d,c){var s=n.call(this,e,t,r,a)||this;return s.changeDetector=i,s.dataService=a,s.formBuilder=d,s.notificationService=c,s.conditions=[],s.actions=[],s.allConditions=[],s.allActions=[],s.detailForm=s.formBuilder.group({name:["",o.Validators.required],enabled:!0,couponCode:null,perCustomerUsageLimit:null,startsAt:null,endsAt:null,conditions:s.formBuilder.array([]),actions:s.formBuilder.array([])}),s}return s(t,n),t.prototype.ngOnInit=function(){var n=this;this.init(),this.promotion$=this.entity$,this.dataService.promotion.getPromotionActionsAndConditions().single$.subscribe((function(t){n.allActions=t.promotionActions,n.allConditions=t.promotionConditions,n.changeDetector.markForCheck()}))},t.prototype.ngOnDestroy=function(){this.destroy()},t.prototype.getAvailableConditions=function(){var n=this;return this.allConditions.filter((function(t){return!n.conditions.find((function(n){return n.code===t.code}))}))},t.prototype.getConditionDefinition=function(n){return this.allConditions.find((function(t){return t.code===n.code}))},t.prototype.getAvailableActions=function(){var n=this;return this.allActions.filter((function(t){return!n.actions.find((function(n){return n.code===t.code}))}))},t.prototype.getActionDefinition=function(n){return this.allActions.find((function(t){return t.code===n.code}))},t.prototype.saveButtonEnabled=function(){return this.detailForm.dirty&&this.detailForm.valid&&(0!==this.conditions.length||this.detailForm.value.couponCode)&&0!==this.actions.length},t.prototype.addCondition=function(n){this.addOperation("conditions",n),this.detailForm.markAsDirty()},t.prototype.addAction=function(n){this.addOperation("actions",n),this.detailForm.markAsDirty()},t.prototype.removeCondition=function(n){this.removeOperation("conditions",n),this.detailForm.markAsDirty()},t.prototype.removeAction=function(n){this.removeOperation("actions",n),this.detailForm.markAsDirty()},t.prototype.formArrayOf=function(n){return this.detailForm.get(n)},t.prototype.create=function(){var n=this;if(this.detailForm.dirty){var t=this.detailForm.value,o={name:t.name,enabled:!0,couponCode:t.couponCode,perCustomerUsageLimit:t.perCustomerUsageLimit,startsAt:t.startsAt,endsAt:t.endsAt,conditions:this.mapOperationsToInputs(this.conditions,t.conditions),actions:this.mapOperationsToInputs(this.actions,t.actions)};this.dataService.promotion.createPromotion(o).subscribe((function(t){var o=t.createPromotion;switch(o.__typename){case"Promotion":n.notificationService.success(r.marker("common.notify-create-success"),{entity:"Promotion"}),n.detailForm.markAsPristine(),n.changeDetector.markForCheck(),n.router.navigate(["../",o.id],{relativeTo:n.route});break;case"MissingConditionsError":n.notificationService.error(o.message)}}),(function(t){n.notificationService.error(r.marker("common.notify-create-error"),{entity:"Promotion"})}))}},t.prototype.save=function(){var n=this;if(this.detailForm.dirty){var t=this.detailForm.value;this.promotion$.pipe(a.take(1),a.mergeMap((function(o){var e={id:o.id,name:t.name,enabled:t.enabled,couponCode:t.couponCode,perCustomerUsageLimit:t.perCustomerUsageLimit,startsAt:t.startsAt,endsAt:t.endsAt,conditions:n.mapOperationsToInputs(n.conditions,t.conditions),actions:n.mapOperationsToInputs(n.actions,t.actions)};return n.dataService.promotion.updatePromotion(e)}))).subscribe((function(t){n.notificationService.success(r.marker("common.notify-update-success"),{entity:"Promotion"}),n.detailForm.markAsPristine(),n.changeDetector.markForCheck()}),(function(t){n.notificationService.error(r.marker("common.notify-update-error"),{entity:"Promotion"})}))}},t.prototype.setFormValues=function(n,t){var o=this;this.detailForm.patchValue({name:n.name,enabled:n.enabled,couponCode:n.couponCode,perCustomerUsageLimit:n.perCustomerUsageLimit,startsAt:n.startsAt,endsAt:n.endsAt}),n.conditions.forEach((function(n){o.addOperation("conditions",n)})),n.actions.forEach((function(n){return o.addOperation("actions",n)}))},t.prototype.mapOperationsToInputs=function(n,t){return n.map((function(n,o){return{code:n.code,arguments:Object.values(t[o].args).map((function(t,o){return{name:n.args[o].name,value:i.encodeConfigArgValue(t)}}))}}))},t.prototype.addOperation=function(n,t){var o=this,e=this.formArrayOf(n),r="conditions"===n?this.conditions:this.actions;if(-1===e.value.findIndex((function(n){return n.code===t.code}))){var a=t.args.reduce((function(e,r){var a,d;return Object.assign(Object.assign({},e),((a={})[r.name]=null!==(d=i.getConfigArgValue(r.value))&&void 0!==d?d:o.getDefaultArgValue(n,t,r.name),a))}),{});e.push(this.formBuilder.control({code:t.code,args:a})),r.push({code:t.code,args:t.args.map((function(n){return{name:n.name,value:i.getConfigArgValue(n.value)}}))})}},t.prototype.getDefaultArgValue=function(n,t,o){var e="conditions"===n?this.allConditions.find((function(n){return n.code===t.code})):this.allActions.find((function(n){return n.code===t.code}));if(e){var r=e.args.find((function(n){return n.name===o}));if(r)return i.getDefaultConfigArgValue(r)}throw new Error('Could not determine default value for "argName"')},t.prototype.removeOperation=function(n,t){var o=this.formArrayOf(n),e="conditions"===n?this.conditions:this.actions,r=o.value.findIndex((function(n){return n.code===t.code}));-1!==r&&(o.removeAt(r),e.splice(r,1))},t}(i.BaseDetailComponent);u.decorators=[{type:t.Component,args:[{selector:"vdr-promotion-detail",template:'<vdr-action-bar>\n    <vdr-ab-left>\n        <div class="flex clr-align-items-center">\n            <vdr-entity-info [entity]="entity$ | async"></vdr-entity-info>\n            <clr-toggle-wrapper *vdrIfPermissions="\'UpdatePromotion\'">\n                <input type="checkbox" clrToggle name="enabled" [formControl]="detailForm.get([\'enabled\'])" />\n                <label>{{ \'common.enabled\' | translate }}</label>\n            </clr-toggle-wrapper>\n        </div>\n    </vdr-ab-left>\n\n    <vdr-ab-right>\n        <vdr-action-bar-items locationId="promotion-detail"></vdr-action-bar-items>\n        <button\n            class="btn btn-primary"\n            *ngIf="isNew$ | async; else updateButton"\n            (click)="create()"\n            [disabled]="!saveButtonEnabled()"\n        >\n            {{ \'common.create\' | translate }}\n        </button>\n        <ng-template #updateButton>\n            <button\n                class="btn btn-primary"\n                (click)="save()"\n                *vdrIfPermissions="\'UpdatePromotion\'"\n                [disabled]="!saveButtonEnabled()"\n            >\n                {{ \'common.update\' | translate }}\n            </button>\n        </ng-template>\n    </vdr-ab-right>\n</vdr-action-bar>\n\n<form class="form" [formGroup]="detailForm">\n    <vdr-form-field [label]="\'common.name\' | translate" for="name">\n        <input\n            id="name"\n            [readonly]="!(\'UpdatePromotion\' | hasPermission)"\n            type="text"\n            formControlName="name"\n        />\n    </vdr-form-field>\n    <vdr-form-field [label]="\'marketing.starts-at\' | translate" for="startsAt">\n        <vdr-datetime-picker formControlName="startsAt"></vdr-datetime-picker>\n    </vdr-form-field>\n    <vdr-form-field [label]="\'marketing.ends-at\' | translate" for="endsAt">\n        <vdr-datetime-picker formControlName="endsAt"></vdr-datetime-picker>\n    </vdr-form-field>\n    <vdr-form-field [label]="\'marketing.coupon-code\' | translate" for="couponCode">\n        <input\n            id="couponCode"\n            [readonly]="!(\'UpdatePromotion\' | hasPermission)"\n            type="text"\n            formControlName="couponCode"\n        />\n    </vdr-form-field>\n    <vdr-form-field [label]="\'marketing.per-customer-limit\' | translate" for="perCustomerUsageLimit">\n        <input\n            id="perCustomerUsageLimit"\n            [readonly]="!(\'UpdatePromotion\' | hasPermission)"\n            type="number"\n            min="1"\n            max="999"\n            formControlName="perCustomerUsageLimit"\n        />\n    </vdr-form-field>\n\n    <div class="clr-row">\n        <div class="clr-col" formArrayName="conditions">\n            <label class="clr-control-label">{{ \'marketing.conditions\' | translate }}</label>\n            <ng-container *ngFor="let condition of conditions; index as i">\n                <vdr-configurable-input\n                    (remove)="removeCondition($event)"\n                    [readonly]="!(\'UpdatePromotion\' | hasPermission)"\n                    [operation]="condition"\n                    [operationDefinition]="getConditionDefinition(condition)"\n                    [formControlName]="i"\n                ></vdr-configurable-input>\n            </ng-container>\n\n            <div>\n                <vdr-dropdown *vdrIfPermissions="\'UpdatePromotion\'">\n                    <button class="btn btn-outline" vdrDropdownTrigger>\n                        <clr-icon shape="plus"></clr-icon>\n                        {{ \'marketing.add-condition\' | translate }}\n                    </button>\n                    <vdr-dropdown-menu vdrPosition="bottom-left">\n                        <button\n                            *ngFor="let condition of getAvailableConditions()"\n                            type="button"\n                            vdrDropdownItem\n                            (click)="addCondition(condition)"\n                        >\n                            {{ condition.description }}\n                        </button>\n                    </vdr-dropdown-menu>\n                </vdr-dropdown>\n            </div>\n        </div>\n        <div class="clr-col" formArrayName="actions">\n            <label class="clr-control-label">{{ \'marketing.actions\' | translate }}</label>\n            <vdr-configurable-input\n                *ngFor="let action of actions; index as i"\n                (remove)="removeAction($event)"\n                [operation]="action"\n                [readonly]="!(\'UpdatePromotion\' | hasPermission)"\n                [operationDefinition]="getActionDefinition(action)"\n                [formControlName]="i"\n            ></vdr-configurable-input>\n            <div>\n                <vdr-dropdown *vdrIfPermissions="\'UpdatePromotion\'">\n                    <button class="btn btn-outline" vdrDropdownTrigger>\n                        <clr-icon shape="plus"></clr-icon>\n                        {{ \'marketing.add-action\' | translate }}\n                    </button>\n                    <vdr-dropdown-menu vdrPosition="bottom-left">\n                        <button\n                            *ngFor="let action of getAvailableActions()"\n                            type="button"\n                            vdrDropdownItem\n                            (click)="addAction(action)"\n                        >\n                            {{ action.description }}\n                        </button>\n                    </vdr-dropdown-menu>\n                </vdr-dropdown>\n            </div>\n        </div>\n    </div>\n</form>\n',changeDetection:t.ChangeDetectionStrategy.OnPush,styles:[""]}]}],u.ctorParameters=function(){return[{type:e.Router},{type:e.ActivatedRoute},{type:i.ServerConfigService},{type:t.ChangeDetectorRef},{type:i.DataService},{type:o.FormBuilder},{type:i.NotificationService}]};var p=function(n){function t(t,o,e,r,i){var a=n.call(this,o,e)||this;return a.dataService=t,a.notificationService=r,a.modalService=i,n.prototype.setQueryFn.call(a,(function(){for(var n,t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];return(n=a.dataService.promotion).getPromotions.apply(n,m(t)).refetchOnChannelChange()}),(function(n){return n.promotions})),a}return s(t,n),t.prototype.deletePromotion=function(n){var t=this;this.modalService.dialog({title:r.marker("catalog.confirm-delete-promotion"),buttons:[{type:"secondary",label:r.marker("common.cancel")},{type:"danger",label:r.marker("common.delete"),returnValue:!0}]}).pipe(a.switchMap((function(o){return o?t.dataService.promotion.deletePromotion(n):d.EMPTY}))).subscribe((function(){t.notificationService.success(r.marker("common.notify-delete-success"),{entity:"Promotion"}),t.refresh()}),(function(n){t.notificationService.error(r.marker("common.notify-delete-error"),{entity:"Promotion"})}))},t}(i.BaseListComponent);p.decorators=[{type:t.Component,args:[{selector:"vdr-promotion-list",template:'<vdr-action-bar>\n    <vdr-ab-right>\n        <vdr-action-bar-items locationId="promotion-list"></vdr-action-bar-items>\n        <a class="btn btn-primary"\n           *vdrIfPermissions="\'CreatePromotion\'"\n           [routerLink]="[\'./create\']">\n            <clr-icon shape="plus"></clr-icon>\n            {{ \'marketing.create-new-promotion\' | translate }}\n        </a>\n    </vdr-ab-right>\n</vdr-action-bar>\n\n<vdr-data-table\n    [items]="items$ | async"\n    [itemsPerPage]="itemsPerPage$ | async"\n    [totalItems]="totalItems$ | async"\n    [currentPage]="currentPage$ | async"\n    (pageChange)="setPageNumber($event)"\n    (itemsPerPageChange)="setItemsPerPage($event)"\n>\n    <vdr-dt-column>{{ \'common.name\' | translate }}</vdr-dt-column>\n    <vdr-dt-column>{{ \'marketing.coupon-code\' | translate }}</vdr-dt-column>\n    <vdr-dt-column>{{ \'marketing.starts-at\' | translate }}</vdr-dt-column>\n    <vdr-dt-column>{{ \'marketing.ends-at\' | translate }}</vdr-dt-column>\n    <vdr-dt-column></vdr-dt-column>\n    <vdr-dt-column></vdr-dt-column>\n    <vdr-dt-column></vdr-dt-column>\n    <ng-template let-promotion="item">\n        <td class="left align-middle">{{ promotion.name }}</td>\n        <td class="left align-middle">\n            <vdr-chip *ngIf="promotion.couponCode">\n                {{ promotion.couponCode }}\n            </vdr-chip>\n        </td>\n        <td class="left align-middle">{{ promotion.startsAt | localeDate: \'longDate\' }}</td>\n        <td class="left align-middle">{{ promotion.endsAt | localeDate: \'longDate\' }}</td>\n        <td class="align-middle">\n            <vdr-chip *ngIf="!promotion.enabled">{{ \'common.disabled\' | translate }}</vdr-chip>\n        </td>\n        <td class="right align-middle">\n            <vdr-table-row-action\n                iconShape="edit"\n                [label]="\'common.edit\' | translate"\n                [linkTo]="[\'./\', promotion.id]"\n            ></vdr-table-row-action>\n        </td>\n        <td class="right align-middle">\n            <vdr-dropdown>\n                <button type="button" class="btn btn-link btn-sm" vdrDropdownTrigger>\n                    {{ \'common.actions\' | translate }}\n                    <clr-icon shape="caret down"></clr-icon>\n                </button>\n                <vdr-dropdown-menu vdrPosition="bottom-right">\n                    <button\n                        type="button"\n                        class="delete-button"\n                        (click)="deletePromotion(promotion.id)"\n                        [disabled]="!(\'DeletePromotion\' | hasPermission)"\n                        vdrDropdownItem\n                    >\n                        <clr-icon shape="trash" class="is-danger"></clr-icon>\n                        {{ \'common.delete\' | translate }}\n                    </button>\n                </vdr-dropdown-menu>\n            </vdr-dropdown>\n        </td>\n    </ng-template>\n</vdr-data-table>\n',changeDetection:t.ChangeDetectionStrategy.OnPush,styles:[""]}]}],p.ctorParameters=function(){return[{type:i.DataService},{type:e.Router},{type:e.ActivatedRoute},{type:i.NotificationService},{type:i.ModalService}]};var f=function(n){function t(t,o){return n.call(this,t,{__typename:"Promotion",id:"",createdAt:"",updatedAt:"",name:"",enabled:!1,conditions:[],actions:[]},(function(n){return o.promotion.getPromotion(n).mapStream((function(n){return n.promotion}))}))||this}return s(t,n),t}(i.BaseEntityResolver);f.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new f(t.ɵɵinject(e.Router),t.ɵɵinject(i.DataService))},token:f,providedIn:"root"}),f.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],f.ctorParameters=function(){return[{type:e.Router},{type:i.DataService}]};var v={breadcrumb:r.marker("breadcrumb.promotions")},g={breadcrumb:y},b=[{path:"promotions",component:p,data:v},{path:"promotions/:id",component:u,resolve:i.createResolveData(f),canDeactivate:[i.CanDeactivateDetailGuard],data:g}];function y(n,t){return i.detailBreadcrumb({entity:n.entity,id:t.id,breadcrumbKey:"breadcrumb.promotions",getName:function(n){return n.name},route:"promotions"})}var h=function(){};h.decorators=[{type:t.NgModule,args:[{imports:[i.SharedModule,e.RouterModule.forChild(b)],declarations:[p,u]}]}],n.MarketingModule=h,n.PromotionDetailComponent=u,n.PromotionListComponent=p,n.PromotionResolver=f,n.marketingRoutes=b,n.promotionBreadcrumb=y,n.ɵ0=v,n.ɵ1=g,Object.defineProperty(n,"__esModule",{value:!0})}));
//# sourceMappingURL=vendure-admin-ui-marketing.umd.min.js.map