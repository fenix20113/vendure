import { chainCommands, exitCode, joinDown, joinUp, lift, selectParentNode, setBlockType, toggleMark, wrapIn, } from 'prosemirror-commands';
import { redo, undo } from 'prosemirror-history';
import { undoInputRule } from 'prosemirror-inputrules';
import { liftListItem, sinkListItem, splitListItem, wrapInList } from 'prosemirror-schema-list';
const mac = typeof navigator !== 'undefined' ? /Mac/.test(navigator.platform) : false;
// :: (Schema, ?Object) â†’ Object
// Inspect the given schema looking for marks and nodes from the
// basic schema, and if found, add key bindings related to them.
// This will add:
//
// * **Mod-b** for toggling [strong](#schema-basic.StrongMark)
// * **Mod-i** for toggling [emphasis](#schema-basic.EmMark)
// * **Mod-`** for toggling [code font](#schema-basic.CodeMark)
// * **Ctrl-Shift-0** for making the current textblock a paragraph
// * **Ctrl-Shift-1** to **Ctrl-Shift-Digit6** for making the current
//   textblock a heading of the corresponding level
// * **Ctrl-Shift-Backslash** to make the current textblock a code block
// * **Ctrl-Shift-8** to wrap the selection in an ordered list
// * **Ctrl-Shift-9** to wrap the selection in a bullet list
// * **Ctrl->** to wrap the selection in a block quote
// * **Enter** to split a non-empty textblock in a list item while at
//   the same time splitting the list item
// * **Mod-Enter** to insert a hard break
// * **Mod-_** to insert a horizontal rule
// * **Backspace** to undo an input rule
// * **Alt-ArrowUp** to `joinUp`
// * **Alt-ArrowDown** to `joinDown`
// * **Mod-BracketLeft** to `lift`
// * **Escape** to `selectParentNode`
//
// You can suppress or map these bindings by passing a `mapKeys`
// argument, which maps key names (say `"Mod-B"` to either `false`, to
// remove the binding, or a new key name string.
export function buildKeymap(schema, mapKeys) {
    const keys = {};
    let type;
    function bind(key, cmd) {
        if (mapKeys) {
            const mapped = mapKeys[key];
            if (mapped === false) {
                return;
            }
            if (mapped) {
                key = mapped;
            }
        }
        keys[key] = cmd;
    }
    bind('Mod-z', undo);
    bind('Shift-Mod-z', redo);
    bind('Backspace', undoInputRule);
    if (!mac) {
        bind('Mod-y', redo);
    }
    bind('Alt-ArrowUp', joinUp);
    bind('Alt-ArrowDown', joinDown);
    bind('Mod-BracketLeft', lift);
    bind('Escape', selectParentNode);
    // tslint:disable:no-conditional-assignment
    if ((type = schema.marks.strong)) {
        bind('Mod-b', toggleMark(type));
        bind('Mod-B', toggleMark(type));
    }
    if ((type = schema.marks.em)) {
        bind('Mod-i', toggleMark(type));
        bind('Mod-I', toggleMark(type));
    }
    if ((type = schema.marks.code)) {
        bind('Mod-`', toggleMark(type));
    }
    if ((type = schema.nodes.bullet_list)) {
        bind('Shift-Ctrl-8', wrapInList(type));
    }
    if ((type = schema.nodes.ordered_list)) {
        bind('Shift-Ctrl-9', wrapInList(type));
    }
    if ((type = schema.nodes.blockquote)) {
        bind('Ctrl->', wrapIn(type));
    }
    if ((type = schema.nodes.hard_break)) {
        const br = type;
        const cmd = chainCommands(exitCode, (state, dispatch) => {
            // tslint:disable-next-line:no-non-null-assertion
            dispatch(state.tr.replaceSelectionWith(br.create()).scrollIntoView());
            return true;
        });
        bind('Mod-Enter', cmd);
        bind('Shift-Enter', cmd);
        if (mac) {
            bind('Ctrl-Enter', cmd);
        }
    }
    if ((type = schema.nodes.list_item)) {
        bind('Enter', splitListItem(type));
        bind('Mod-[', liftListItem(type));
        bind('Mod-]', sinkListItem(type));
    }
    if ((type = schema.nodes.paragraph)) {
        bind('Shift-Ctrl-0', setBlockType(type));
    }
    if ((type = schema.nodes.code_block)) {
        bind('Shift-Ctrl-\\', setBlockType(type));
    }
    if ((type = schema.nodes.heading)) {
        for (let i = 1; i <= 6; i++) {
            bind('Shift-Ctrl-' + i, setBlockType(type, { level: i }));
        }
    }
    if ((type = schema.nodes.horizontal_rule)) {
        const hr = type;
        bind('Mod-_', (state, dispatch) => {
            dispatch(state.tr.replaceSelectionWith(hr.create()).scrollIntoView());
            return true;
        });
    }
    return keys;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5bWFwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9jb3JlL3NyYy9zaGFyZWQvY29tcG9uZW50cy9yaWNoLXRleHQtZWRpdG9yL3Byb3NlbWlycm9yL2tleW1hcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0gsYUFBYSxFQUNiLFFBQVEsRUFDUixRQUFRLEVBQ1IsTUFBTSxFQUNOLElBQUksRUFDSixnQkFBZ0IsRUFDaEIsWUFBWSxFQUNaLFVBQVUsRUFDVixNQUFNLEdBQ1QsTUFBTSxzQkFBc0IsQ0FBQztBQUM5QixPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUV2RCxPQUFPLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsVUFBVSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFJaEcsTUFBTSxHQUFHLEdBQUcsT0FBTyxTQUFTLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO0FBRXRGLGdDQUFnQztBQUNoQyxnRUFBZ0U7QUFDaEUsZ0VBQWdFO0FBQ2hFLGlCQUFpQjtBQUNqQixFQUFFO0FBQ0YsOERBQThEO0FBQzlELDREQUE0RDtBQUM1RCwrREFBK0Q7QUFDL0Qsa0VBQWtFO0FBQ2xFLHFFQUFxRTtBQUNyRSxtREFBbUQ7QUFDbkQsd0VBQXdFO0FBQ3hFLDhEQUE4RDtBQUM5RCw0REFBNEQ7QUFDNUQsc0RBQXNEO0FBQ3RELHFFQUFxRTtBQUNyRSwwQ0FBMEM7QUFDMUMseUNBQXlDO0FBQ3pDLDBDQUEwQztBQUMxQyx3Q0FBd0M7QUFDeEMsZ0NBQWdDO0FBQ2hDLG9DQUFvQztBQUNwQyxrQ0FBa0M7QUFDbEMscUNB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QUU7WUFDekIsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLEVBQUUsWUFBWSxDQUFDLElBQUksRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDN0Q7S0FDSjtJQUNELElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsRUFBRTtRQUN2QyxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDaEIsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsRUFBRTtZQUM5QixRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO1lBQ3RFLE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO0tBQ047SUFFRCxPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBjaGFpbkNvbW1hbmRzLFxuICAgIGV4aXRDb2RlLFxuICAgIGpvaW5Eb3duLFxuICAgIGpvaW5VcCxcbiAgICBsaWZ0LFxuICAgIHNlbGVjdFBhcmVudE5vZGUsXG4gICAgc2V0QmxvY2tUeXBlLFxuICAgIHRvZ2dsZU1hcmssXG4gICAgd3JhcEluLFxufSBmcm9tICdwcm9zZW1pcnJvci1jb21tYW5kcyc7XG5pbXBvcnQgeyByZWRvLCB1bmRvIH0gZnJvbSAncHJvc2VtaXJyb3ItaGlzdG9yeSc7XG5pbXBvcnQgeyB1bmRvSW5wdXRSdWxlIH0gZnJvbSAncHJvc2VtaXJyb3ItaW5wdXRydWxlcyc7XG5pbXBvcnQgeyBNYXJrVHlwZSwgTm9kZVR5cGUsIFNjaGVtYSB9IGZyb20gJ3Byb3NlbWlycm9yLW1vZGVsJztcbmltcG9ydCB7IGxpZnRMaXN0SXRlbSwgc2lua0xpc3RJdGVtLCBzcGxpdExpc3RJdGVtLCB3cmFwSW5MaXN0IH0gZnJvbSAncHJvc2VtaXJyb3Itc2NoZW1hLWxpc3QnO1xuXG5pbXBvcnQgeyBLZXltYXAgfSBmcm9tICcuL3R5cGVzJztcblxuY29uc3QgbWFjID0gdHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcgPyAvTWFjLy50ZXN0KG5hdmlnYXRvci5wbGF0Zm9ybSkgOiBmYWxzZTtcblxuLy8gOjogKFNjaGVtYSwgP09iamVjdCkg4oaSIE9iamVjdFxuLy8gSW5zcGVjdCB0aGUgZ2l2ZW4gc2NoZW1hIGxvb2tpbmcgZm9yIG1hcmtzIGFuZCBub2RlcyBmcm9tIHRoZVxuLy8gYmFzaWMgc2NoZW1hLCBhbmQgaWYgZm91bmQsIGFkZCBrZXkgYmluZGluZ3MgcmVsYXRlZCB0byB0aGVtLlxuLy8gVGhpcyB3aWxsIGFkZDpcbi8vXG4vLyAqICoqTW9kLWIqKiBmb3IgdG9nZ2xpbmcgW3N0cm9uZ10oI3NjaGVtYS1iYXNpYy5TdHJvbmdNYXJrKVxuLy8gKiAqKk1vZC1pKiogZm9yIHRvZ2dsaW5nIFtlbXBoYXNpc10oI3NjaGVtYS1iYXNpYy5FbU1hcmspXG4vLyAqICoqTW9kLWAqKiBmb3IgdG9nZ2xpbmcgW2NvZGUgZm9udF0oI3NjaGVtYS1iYXNpYy5Db2RlTWFyaylcbi8vICogKipDdHJsLVNoaWZ0LTAqKiBmb3IgbWFraW5nIHRoZSBjdXJyZW50IHRleHRibG9jayBhIHBhcmFncmFwaFxuLy8gKiAqKkN0cmwtU2hpZnQtMSoqIHRvICoqQ3RybC1TaGlmdC1EaWdpdDYqKiBmb3IgbWFraW5nIHRoZSBjdXJyZW50XG4vLyAgIHRleHRibG9jayBhIGhlYWRpbmcgb2YgdGhlIGNvcnJlc3BvbmRpbmcgbGV2ZWxcbi8vICogKipDdHJsLVNoaWZ0LUJhY2tzbGFzaCoqIHRvIG1ha2UgdGhlIGN1cnJlbnQgdGV4dGJsb2NrIGEgY29kZSBibG9ja1xuLy8gKiAqKkN0cmwtU2hpZnQtOCoqIHRvIHdyYXAgdGhlIHNlbGVjdGlvbiBpbiBhbiBvcmRlcmVkIGxpc3Rcbi8vICogKipDdHJsLVNoaWZ0LTkqKiB0byB3cmFwIHRoZSBzZWxlY3Rpb24gaW4gYSBidWxsZXQgbGlzdFxuLy8gKiAqKkN0cmwtPioqIHRvIHdyYXAgdGhlIHNlbGVjdGlvbiBpbiBhIGJsb2NrIHF1b3RlXG4vLyAqICoqRW50ZXIqKiB0byBzcGxpdCBhIG5vbi1lbXB0eSB0ZXh0YmxvY2sgaW4gYSBsaXN0IGl0ZW0gd2hpbGUgYXRcbi8vICAgdGhlIHNhbWUgdGltZSBzcGxpdHRpbmcgdGhlIGxpc3QgaXRlbVxuLy8gKiAqKk1vZC1FbnRlcioqIHRvIGluc2VydCBhIGhhcmQgYnJlYWtcbi8vICogKipNb2QtXyoqIHRvIGluc2VydCBhIGhvcml6b250YWwgcnVsZVxuLy8gKiAqKkJhY2tzcGFjZSoqIHRvIHVuZG8gYW4gaW5wdXQgcnVsZVxuLy8gKiAqKkFsdC1BcnJvd1VwKiogdG8gYGpvaW5VcGBcbi8vICogKipBbHQtQXJyb3dEb3duKiogdG8gYGpvaW5Eb3duYFxuLy8gKiAqKk1vZC1CcmFja2V0TGVmdCoqIHRvIGBsaWZ0YFxuLy8gKiAqKkVzY2FwZSoqIHRvIGBzZWxlY3RQYXJlbnROb2RlYFxuLy9cbi8vIFlvdSBjYW4gc3VwcHJlc3Mgb3IgbWFwIHRoZXNlIGJpbmRpbmdzIGJ5IHBhc3NpbmcgYSBgbWFwS2V5c2Bcbi8vIGFyZ3VtZW50LCB3aGljaCBtYXBzIGtleSBuYW1lcyAoc2F5IGBcIk1vZC1CXCJgIHRvIGVpdGhlciBgZmFsc2VgLCB0b1xuLy8gcmVtb3ZlIHRoZSBiaW5kaW5nLCBvciBhIG5ldyBrZXkgbmFtZSBzdHJpbmcuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRLZXltYXAoc2NoZW1hOiBTY2hlbWEsIG1hcEtleXM/OiBLZXltYXApIHtcbiAgICBjb25zdCBrZXlzID0ge307XG4gICAgbGV0IHR5cGU6IE1hcmtUeXBlIHwgTm9kZVR5cGU7XG4gICAgZnVuY3Rpb24gYmluZChrZXk6IHN0cmluZywgY21kOiAoLi4uYXJnczogYW55W10pID0+IGJvb2xlYW4pIHtcbiAgICAgICAgaWYgKG1hcEtleXMpIHtcbiAgICAgICAgICAgIGNvbnN0IG1hcHBlZCA9IG1hcEtleXNba2V5XTtcbiAgICAgICAgICAgIGlmIChtYXBwZWQgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG1hcHBlZCkge1xuICAgICAgICAgICAgICAgIGtleSA9IG1hcHBlZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBrZXlzW2tleV0gPSBjbWQ7XG4gICAgfVxuXG4gICAgYmluZCgnTW9kLXonLCB1bmRvKTtcbiAgICBiaW5kKCdTaGlmdC1Nb2QteicsIHJlZG8pO1xuICAgIGJpbmQoJ0JhY2tzcGFjZScsIHVuZG9JbnB1dFJ1bGUpO1xuICAgIGlmICghbWFjKSB7XG4gICAgICAgIGJpbmQoJ01vZC15JywgcmVkbyk7XG4gICAgfVxuXG4gICAgYmluZCgnQWx0LUFycm93VXAnLCBqb2luVXApO1xuICAgIGJpbmQoJ0FsdC1BcnJvd0Rvd24nLCBqb2luRG93bik7XG4gICAgYmluZCgnTW9kLUJyYWNrZXRMZWZ0JywgbGlmdCk7XG4gICAgYmluZCgnRXNjYXBlJywgc2VsZWN0UGFyZW50Tm9kZSk7XG5cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZTpuby1jb25kaXRpb25hbC1hc3NpZ25tZW50XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm1hcmtzLnN0cm9uZykpIHtcbiAgICAgICAgYmluZCgnTW9kLWInLCB0b2dnbGVNYXJrKHR5cGUpKTtcbiAgICAgICAgYmluZCgnTW9kLUInLCB0b2dnbGVNYXJrKHR5cGUpKTtcbiAgICB9XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm1hcmtzLmVtKSkge1xuICAgICAgICBiaW5kKCdNb2QtaScsIHRvZ2dsZU1hcmsodHlwZSkpO1xuICAgICAgICBiaW5kKCdNb2QtSScsIHRvZ2dsZU1hcmsodHlwZSkpO1xuICAgIH1cbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubWFya3MuY29kZSkpIHtcbiAgICAgICAgYmluZCgnTW9kLWAnLCB0b2dnbGVNYXJrKHR5cGUpKTtcbiAgICB9XG5cbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMuYnVsbGV0X2xpc3QpKSB7XG4gICAgICAgIGJpbmQoJ1NoaWZ0LUN0cmwtOCcsIHdyYXBJbkxpc3QodHlwZSkpO1xuICAgIH1cbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMub3JkZXJlZF9saXN0KSkge1xuICAgICAgICBiaW5kKCdTaGlmdC1DdHJsLTknLCB3cmFwSW5MaXN0KHR5cGUpKTtcbiAgICB9XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLmJsb2NrcXVvdGUpKSB7XG4gICAgICAgIGJpbmQoJ0N0cmwtPicsIHdyYXBJbih0eXBlKSk7XG4gICAgfVxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5oYXJkX2JyZWFrKSkge1xuICAgICAgICBjb25zdCBiciA9IHR5cGU7XG4gICAgICAgIGNvbnN0IGNtZCA9IGNoYWluQ29tbWFuZHMoZXhpdENvZGUsIChzdGF0ZSwgZGlzcGF0Y2gpID0+IHtcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgICAgICAgIGRpc3BhdGNoIShzdGF0ZS50ci5yZXBsYWNlU2VsZWN0aW9uV2l0aChici5jcmVhdGUoKSkuc2Nyb2xsSW50b1ZpZXcoKSk7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgICAgIGJpbmQoJ01vZC1FbnRlcicsIGNtZCk7XG4gICAgICAgIGJpbmQoJ1NoaWZ0LUVudGVyJywgY21kKTtcbiAgICAgICAgaWYgKG1hYykge1xuICAgICAgICAgICAgYmluZCgnQ3RybC1FbnRlcicsIGNtZCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLmxpc3RfaXRlbSkpIHtcbiAgICAgICAgYmluZCgnRW50ZXInLCBzcGxpdExpc3RJdGVtKHR5cGUpKTtcbiAgICAgICAgYmluZCgnTW9kLVsnLCBsaWZ0TGlzdEl0ZW0odHlwZSkpO1xuICAgICAgICBiaW5kKCdNb2QtXScsIHNpbmtMaXN0SXRlbSh0eXBlKSk7XG4gICAgfVxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5wYXJhZ3JhcGgpKSB7XG4gICAgICAgIGJpbmQoJ1NoaWZ0LUN0cmwtMCcsIHNldEJsb2NrVHlwZSh0eXBlKSk7XG4gICAgfVxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5jb2RlX2Jsb2NrKSkge1xuICAgICAgICBiaW5kKCdTaGlmdC1DdHJsLVxcXFwnLCBzZXRCbG9ja1R5cGUodHlwZSkpO1xuICAgIH1cbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMuaGVhZGluZykpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gNjsgaSsrKSB7XG4gICAgICAgICAgICBiaW5kKCdTaGlmdC1DdHJsLScgKyBpLCBzZXRCbG9ja1R5cGUodHlwZSwgeyBsZXZlbDogaSB9KSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLmhvcml6b250YWxfcnVsZSkpIHtcbiAgICAgICAgY29uc3QgaHIgPSB0eXBlO1xuICAgICAgICBiaW5kKCdNb2QtXycsIChzdGF0ZSwgZGlzcGF0Y2gpID0+IHtcbiAgICAgICAgICAgIGRpc3BhdGNoKHN0YXRlLnRyLnJlcGxhY2VTZWxlY3Rpb25XaXRoKGhyLmNyZWF0ZSgpKS5zY3JvbGxJbnRvVmlldygpKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4ga2V5cztcbn1cbiJdfQ==