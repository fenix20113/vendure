import { toggleMark } from 'prosemirror-commands';
import { blockTypeItem, Dropdown, DropdownSubmenu, icons, joinUpItem, liftItem, MenuItem, redoItem, selectParentNodeItem, undoItem, wrapItem, } from 'prosemirror-menu';
import { wrapInList } from 'prosemirror-schema-list';
import { insertImageItem } from './images';
import { linkItem } from './links';
import { canInsert, markActive } from './menu-common';
// Helpers to create specific types of items
function cmdItem(cmd, options) {
    const passedOptions = {
        label: options.title,
        run: cmd,
    };
    // tslint:disable-next-line:forin
    for (const prop in options) {
        passedOptions[prop] = options[prop];
    }
    if ((!options.enable || options.enable === true) && !options.select) {
        passedOptions[options.enable ? 'enable' : 'select'] = state => cmd(state);
    }
    return new MenuItem(passedOptions);
}
function markItem(markType, options) {
    const passedOptions = {
        active(state) {
            return markActive(state, markType);
        },
        enable: true,
    };
    // tslint:disable-next-line:forin
    for (const prop in options) {
        passedOptions[prop] = options[prop];
    }
    return cmdItem(toggleMark(markType), passedOptions);
}
function wrapListItem(nodeType, options) {
    return cmdItem(wrapInList(nodeType, options.attrs), options);
}
// :: (Schema) â†’ Object
// Given a schema, look for default mark and node types in it and
// return an object with relevant menu items relating to those marks:
//
// **`toggleStrong`**`: MenuItem`
//   : A menu item to toggle the [strong mark](#schema-basic.StrongMark).
//
// **`toggleEm`**`: MenuItem`
//   : A menu item to toggle the [emphasis mark](#schema-basic.EmMark).
//
// **`toggleCode`**`: MenuItem`
//   : A menu item to toggle the [code font mark](#schema-basic.CodeMark).
//
// **`toggleLink`**`: MenuItem`
//   : A menu item to toggle the [link mark](#schema-basic.LinkMark).
//
// **`insertImage`**`: MenuItem`
//   : A menu item to insert an [image](#schema-basic.Image).
//
// **`wrapBulletList`**`: MenuItem`
//   : A menu item to wrap the selection in a [bullet list](#schema-list.BulletList).
//
// **`wrapOrderedList`**`: MenuItem`
//   : A menu item to wrap the selection in an [ordered list](#schema-list.OrderedList).
//
// **`wrapBlockQuote`**`: MenuItem`
//   : A menu item to wrap the selection in a [block quote](#schema-basic.BlockQuote).
//
// **`makeParagraph`**`: MenuItem`
//   : A menu item to set the current textblock to be a normal
//     [paragraph](#schema-basic.Paragraph).
//
// **`makeCodeBlock`**`: MenuItem`
//   : A menu item to set the current textblock to be a
//     [code block](#schema-basic.CodeBlock).
//
// **`makeHead[N]`**`: MenuItem`
//   : Where _N_ is 1 to 6. Menu items to set the current textblock to
//     be a [heading](#schema-basic.Heading) of level _N_.
//
// **`insertHorizontalRule`**`: MenuItem`
//   : A menu item to insert a horizontal rule.
//
// The return value also contains some prefabricated menu elements and
// menus, that you can use instead of composing your own menu from
// scratch:
//
// **`insertMenu`**`: Dropdown`
//   : A dropdown containing the `insertImage` and
//     `insertHorizontalRule` items.
//
// **`typeMenu`**`: Dropdown`
//   : A dropdown containing the items for making the current
//     textblock a paragraph, code block, or heading.
//
// **`fullMenu`**`: [[MenuElement]]`
//   : An array of arrays of menu elements for use as the full menu
//     for, for example the [menu bar](https://github.com/prosemirror/prosemirror-menu#user-content-menubar).
export function buildMenuItems(schema, modalService) {
    const r = {};
    let type;
    // tslint:disable:no-conditional-assignment
    if ((type = schema.marks.strong)) {
        r.toggleStrong = markItem(type, { title: 'Toggle strong style', icon: icons.strong });
    }
    if ((type = schema.marks.em)) {
        r.toggleEm = markItem(type, { title: 'Toggle emphasis', icon: icons.em });
    }
    if ((type = schema.marks.code)) {
        r.toggleCode = markItem(type, { title: 'Toggle code font', icon: icons.code });
    }
    if ((type = schema.marks.link)) {
        r.toggleLink = linkItem(type, modalService);
    }
    if ((type = schema.nodes.image)) {
        r.insertImage = insertImageItem(type, modalService);
    }
    if ((type = schema.nodes.bullet_list)) {
        r.wrapBulletList = wrapListItem(type, {
            title: 'Wrap in bullet list',
            icon: icons.bulletList,
        });
    }
    if ((type = schema.nodes.ordered_list)) {
        r.wrapOrderedList = wrapListItem(type, {
            title: 'Wrap in ordered list',
            icon: icons.orderedList,
        });
    }
    if ((type = schema.nodes.blockquote)) {
        r.wrapBlockQuote = wrapItem(type, {
            title: 'Wrap in block quote',
            icon: icons.blockquote,
        });
    }
    if ((type = schema.nodes.paragraph)) {
        r.makeParagraph = blockTypeItem(type, {
            title: 'Change to paragraph',
            label: 'Plain',
        });
    }
    if ((type = schema.nodes.code_block)) {
        r.makeCodeBlock = blockTypeItem(type, {
            title: 'Change to code block',
            label: 'Code',
        });
    }
    if ((type = schema.nodes.heading)) {
        for (let i = 1; i <= 10; i++) {
            r['makeHead' + i] = blockTypeItem(type, {
                title: 'Change to heading ' + i,
                label: 'Level ' + i,
                attrs: { level: i },
            });
        }
    }
    if ((type = schema.nodes.horizontal_rule)) {
        const hr = type;
        r.insertHorizontalRule = new MenuItem({
            title: 'Insert horizontal rule',
            label: 'Horizontal rule',
            class: '',
            css: '',
            enable(state) {
                return canInsert(state, hr);
            },
            run(state, dispatch) {
                dispatch(state.tr.replaceSelectionWith(hr.create()));
            },
        });
    }
    const cut = (arr) => arr.filter(x => x);
    r.insertMenu = new Dropdown(cut([r.insertImage, r.insertHorizontalRule]), { label: 'Insert' });
    r.typeMenu = new Dropdown(cut([
        r.makeParagraph,
        r.makeCodeBlock,
        r.makeHead1 &&
            new DropdownSubmenu(cut([r.makeHead1, r.makeHead2, r.makeHead3, r.makeHead4, r.makeHead5, r.makeHead6]), { label: 'Heading' }),
    ]), { label: 'Type...' });
    const inlineMenu = cut([r.toggleStrong, r.toggleEm, r.toggleLink]);
    r.inlineMenu = [inlineMenu];
    r.blockMenu = [
        cut([
            r.wrapBulletList,
            r.wrapOrderedList,
            r.wrapBlockQuote,
            joinUpItem,
            liftItem,
            selectParentNodeItem,
        ]),
    ];
    r.fullMenu = [inlineMenu].concat([[r.insertMenu, r.typeMenu]], [[undoItem, redoItem]], r.blockMenu);
    return r;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvY29yZS9zcmMvc2hhcmVkL2NvbXBvbmVudHMvcmljaC10ZXh0LWVkaXRvci9wcm9zZW1pcnJvci9tZW51L21lbnUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFDSCxhQUFhLEVBQ2IsUUFBUSxFQUNSLGVBQWUsRUFDZixLQUFLLEVBQ0wsVUFBVSxFQUNWLFFBQVEsRUFDUixRQUFRLEVBQ1IsUUFBUSxFQUNSLG9CQUFvQixFQUNwQixRQUFRLEVBQ1IsUUFBUSxHQUNYLE1BQU0sa0JBQWtCLENBQUM7QUFFMUIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBS3JELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDM0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNuQyxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUV0RCw0Q0FBNEM7QUFFNUMsU0FBUyxPQUFPLENBQUMsR0FBNkIsRUFBRSxPQUE0QjtJQUN4RSxNQUFNLGFBQWEsR0FBRztRQUNsQixLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7UUFDcEIsR0FBRyxFQUFFLEdBQUc7S0FDWCxDQUFDO0lBQ0YsaUNBQWlDO0lBQ2pDLEtBQUssTUFBTSxJQUFJLElBQUksT0FBTyxFQUFFO1FBQ3hCLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDdkM7SUFDRCxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxJQUFJLE9BQU8sQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFO1FBQ2pFLGFBQWEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQzdFO0lBRUQsT0FBTyxJQUFJLFFBQVEsQ0FBQyxhQUFvQixDQUFDLENBQUM7QUFDOUMsQ0FBQztBQUVELFNBQVMsUUFBUSxDQUFDLFFBQVEsRUFBRSxPQUFPO0lBQy9CLE1BQU0sYUFBYSxHQUFHO1FBQ2xCLE1BQU0sQ0FBQyxLQUFLO1lBQ1IsT0FBTyxVQUFVLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZDLENBQUM7UUFDRCxNQUFNLEVBQUUsSUFBSTtLQUNmLENBQUM7SUFDRixpQ0FBaUM7SUFDakMsS0FBSyxNQUFNLElBQUksSUFBSSxPQUFPLEVBQUU7UUFDeEIsYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUN2QztJQUNELE9BQU8sT0FBTyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRSxhQUFhLENBQUMsQ0FBQztBQUN4RCxDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsUUFBUSxFQUFFLE9BQU87SUFDbkMsT0FBTyxPQUFPLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDakUsQ0FBQztBQUVELHVCQUF1QjtBQUN2QixpRUFBaUU7QUFDakUscUVBQXFFO0FBQ3JFLEVBQUU7QUFDRixpQ0FBaUM7QUFDakMseUVBQXlFO0FBQ3pFLEVBQUU7QUFDRiw2QkFBNkI7QUFDN0IsdUVBQXVFO0FBQ3ZFLEVBQUU7QUFDRiwrQkFBK0I7QUFDL0IsMEVBQTBFO0FBQzFFLEVBQUU7QUFDRiwrQkFBK0I7QUFDL0IscUVBQXFFO0FBQ3JFLEVBQUU7QUFDRixnQ0FBZ0M7QUFDaEMsNkRBQTZEO0FBQzdELEVBQUU7QUFDRixtQ0FBbUM7QUFDbkMscUZBQXFGO0FBQ3JGLEVBQUU7QUFDRixvQ0FBb0M7QUFDcEMsd0ZBQXdGO0FBQ3hGLEVBQUU7QUFDRixtQ0FBbUM7QUFDbkMsc0ZBQXNGO0FBQ3RGLEVBQUU7QUFDRixrQ0FBa0M7QUFDbEMsOERBQThEO0FBQzlELDRDQUE0QztBQUM1QyxFQUFFO0FBQ0Ysa0NBQWtDO0FBQ2xDLHVEQUF1RDtBQUN2RCw2Q0FBNkM7QUFDN0MsRUFBRTtBQUNGLGdDQUFnQztBQUNoQyxzRUFBc0U7QUFDdEUsMERBQTBEO0FBQzFELEVBQUU7QUFDRix5Q0FBeUM7QUFDekMsK0NBQStDO0FBQy9DLEVBQUU7QUFDRixzRUFBc0U7QUFDdEUsa0VBQWtFO0FBQ2xFLFdBQVc7QUFDWCxFQUFFO0FBQ0YsK0JBQStCO0FBQy9CLGtEQUFrRDtBQUNsRCxvQ0FBb0M7QUFDcEMsRUFBRTtBQUNGLDZCQUE2QjtBQUM3Qiw2REFBNkQ7QUFDN0QscURBQXFEO0FBQ3JELEVBQUU7QUFDRixvQ0FBb0M7QUFDcEMsbUVBQW1FO0FBQ25FLDZHQUE2RztBQUM3RyxNQUFNLFVBQVUsY0FBYyxDQUFDLE1BQWMsRUFBRSxZQUEwQjtJQUNyRSxNQUFNLENBQUMsR0FBd0IsRUFBRSxDQUFDO0lBQ2xDLElBQUksSUFBeUIsQ0FBQztJQUM5QiwyQ0FBMkM7SUFDM0MsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQzlCLENBQUMsQ0FBQyxZQUFZLEdBQUcsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLEtBQUssRUFBRSxxQkFBcUIsRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7S0FDekY7SUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEVBQUU7UUFDMUIsQ0FBQyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsSUFBSSxFQUFFLEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztLQUM3RTtJQUNELElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUM1QixDQUFDLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQyxJQUFJLEVBQUUsRUFBRSxLQUFLLEVBQUUsa0JBQWtCLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0tBQ2xGO0lBQ0QsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQzVCLENBQUMsQ0FBQyxVQUFVLEdBQUcsUUFBUSxDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztLQUMvQztJQUVELElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUM3QixDQUFDLENBQUMsV0FBVyxHQUFHLGVBQWUsQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLENBQUM7S0FDdkQ7SUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEVBQUU7UUFDbkMsQ0FBQyxDQUFDLGNBQWMsR0FBRyxZQUFZLENBQUMsSUFBSSxFQUFFO1lBQ2xDLEtBQUssRUFBRSxxQkFBcUI7WUFDNUIsSUFBSSxFQUFFLEtBQUssQ0FBQyxVQUFVO1NBQ3pCLENBQUMsQ0FBQztLQUNOO0lBQ0QsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxFQUFFO1FBQ3BDLENBQUMsQ0FBQyxlQUFlLEdBQUcsWUFBWSxDQUFDLElBQUksRUFBRTtZQUNuQyxLQUFLLEVBQUUsc0JBQXNCO1lBQzdCLElBQUksRUFBRSxLQUFLLENBQUMsV0FBVztTQUMxQixDQUFDLENBQUM7S0FDTjtJQUNELElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsRUFBRTtRQUNsQyxDQUFDLENBQUMsY0FBYyxHQUFHLFFBQVEsQ0FBQyxJQUFJLEVBQUU7WUFDOUIsS0FBSyxFQUFFLHFCQUFxQjtZQUM1QixJQUFJLEVBQUUsS0FBSyxDQUFDLFVBQVU7U0FDekIsQ0FBQyxDQUFDO0tBQ047SUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQUU7UUFDakMsQ0FBQyxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUMsSUFBSSxFQUFFO1lBQ2xDLEtBQUssRUFBRSxxQkFBcUI7WUFDNUIsS0FBSyxFQUFFLE9BQU87U0FDakIsQ0FBQyxDQUFDO0tBQ047SUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLEVBQUU7UUFDbEMsQ0FBQyxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUMsSUFBSSxFQUFFO1lBQ2xDLEtBQUssRUFBRSxzQkFBc0I7WUFDN0IsS0FBSyxFQUFFLE1BQU07U0FDaEIsQ0FBQyxDQUFDO0tBQ047SUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUU7UUFDL0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMxQixDQUFDLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxHQUFHLGFBQWEsQ0FBQyxJQUFJLEVBQUU7Z0JBQ3BDLEtBQUssRUFBRSxvQkFBb0IsR0FBRyxDQUFDO2dCQUMvQixLQUFLLEVBQUUsUUFBUSxHQUFHLENBQUM7Z0JBQ25CLEtBQUssRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUU7YUFDdEIsQ0FBQyxDQUFDO1NBQ047S0FDSjtJQUNELElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsRUFBRTtRQUN2QyxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDaEIsQ0FBQyxDQUFDLG9CQUFvQixHQUFHLElBQUksUUFBUSxDQUFDO1lBQ2xDLEtBQUssRUFBRSx3QkFBd0I7WUFDL0IsS0FBSyxFQUFFLGlCQUFpQjtZQUN4QixLQUFLLEVBQUUsRUFBRTtZQUNULEdBQUcsRUFBRSxFQUFFO1lBQ1AsTUFBTSxDQUFDLEtBQUs7Z0JBQ1IsT0FBTyxTQUFTLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ2hDLENBQUM7WUFDRCxHQUFHLENBQUMsS0FBa0IsRUFBRSxRQUFRO2dCQUM1QixRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3pELENBQUM7U0FDSixDQUFDLENBQUM7S0FDTjtJQUVELE1BQU0sR0FBRyxHQUFHLENBQUksR0FBUSxFQUFPLEVBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDckQsQ0FBQyxDQUFDLFVBQVUsR0FBRyxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUMvRixDQUFDLENBQUMsUUFBUSxHQUFHLElBQUksUUFBUSxDQUNyQixHQUFHLENBQUM7UUFDQSxDQUFDLENBQUMsYUFBYTtRQUNmLENBQUMsQ0FBQyxhQUFhO1FBQ2YsQ0FBQyxDQUFDLFNBQVM7WUFDUCxJQUFJLGVBQWUsQ0FDZixHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQ25GLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxDQUN2QjtLQUNSLENBQUMsRUFDRixFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FDdkIsQ0FBQztJQUVGLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUNuRSxDQUFDLENBQUMsVUFBVSxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDNUIsQ0FBQyxDQUFDLFNBQVMsR0FBRztRQUNWLEdBQUcsQ0FBQztZQUNBLENBQUMsQ0FBQyxjQUFjO1lBQ2hCLENBQUMsQ0FBQyxlQUFlO1lBQ2pCLENBQUMsQ0FBQyxjQUFjO1lBQ2hCLFVBQVU7WUFDVixRQUFRO1lBQ1Isb0JBQW9CO1NBQ3ZCLENBQUM7S0FDTCxDQUFDO0lBQ0YsQ0FBQyxDQUFDLFFBQVEsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRXBHLE9BQU8sQ0FBQyxDQUFDO0FBQ2IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHRvZ2dsZU1hcmsgfSBmcm9tICdwcm9zZW1pcnJvci1jb21tYW5kcyc7XG5pbXBvcnQge1xuICAgIGJsb2NrVHlwZUl0ZW0sXG4gICAgRHJvcGRvd24sXG4gICAgRHJvcGRvd25TdWJtZW51LFxuICAgIGljb25zLFxuICAgIGpvaW5VcEl0ZW0sXG4gICAgbGlmdEl0ZW0sXG4gICAgTWVudUl0ZW0sXG4gICAgcmVkb0l0ZW0sXG4gICAgc2VsZWN0UGFyZW50Tm9kZUl0ZW0sXG4gICAgdW5kb0l0ZW0sXG4gICAgd3JhcEl0ZW0sXG59IGZyb20gJ3Byb3NlbWlycm9yLW1lbnUnO1xuaW1wb3J0IHsgTWFya1R5cGUsIE5vZGVUeXBlLCBTY2hlbWEgfSBmcm9tICdwcm9zZW1pcnJvci1tb2RlbCc7XG5pbXBvcnQgeyB3cmFwSW5MaXN0IH0gZnJvbSAncHJvc2VtaXJyb3Itc2NoZW1hLWxpc3QnO1xuaW1wb3J0IHsgRWRpdG9yU3RhdGUgfSBmcm9tICdwcm9zZW1pcnJvci1zdGF0ZSc7XG5cbmltcG9ydCB7IE1vZGFsU2VydmljZSB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL3Byb3ZpZGVycy9tb2RhbC9tb2RhbC5zZXJ2aWNlJztcblxuaW1wb3J0IHsgaW5zZXJ0SW1hZ2VJdGVtIH0gZnJvbSAnLi9pbWFnZXMnO1xuaW1wb3J0IHsgbGlua0l0ZW0gfSBmcm9tICcuL2xpbmtzJztcbmltcG9ydCB7IGNhbkluc2VydCwgbWFya0FjdGl2ZSB9IGZyb20gJy4vbWVudS1jb21tb24nO1xuXG4vLyBIZWxwZXJzIHRvIGNyZWF0ZSBzcGVjaWZpYyB0eXBlcyBvZiBpdGVtc1xuXG5mdW5jdGlvbiBjbWRJdGVtKGNtZDogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkLCBvcHRpb25zOiBSZWNvcmQ8c3RyaW5nLCBhbnk+KSB7XG4gICAgY29uc3QgcGFzc2VkT3B0aW9ucyA9IHtcbiAgICAgICAgbGFiZWw6IG9wdGlvbnMudGl0bGUsXG4gICAgICAgIHJ1bjogY21kLFxuICAgIH07XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmZvcmluXG4gICAgZm9yIChjb25zdCBwcm9wIGluIG9wdGlvbnMpIHtcbiAgICAgICAgcGFzc2VkT3B0aW9uc1twcm9wXSA9IG9wdGlvbnNbcHJvcF07XG4gICAgfVxuICAgIGlmICgoIW9wdGlvbnMuZW5hYmxlIHx8IG9wdGlvbnMuZW5hYmxlID09PSB0cnVlKSAmJiAhb3B0aW9ucy5zZWxlY3QpIHtcbiAgICAgICAgcGFzc2VkT3B0aW9uc1tvcHRpb25zLmVuYWJsZSA/ICdlbmFibGUnIDogJ3NlbGVjdCddID0gc3RhdGUgPT4gY21kKHN0YXRlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IE1lbnVJdGVtKHBhc3NlZE9wdGlvbnMgYXMgYW55KTtcbn1cblxuZnVuY3Rpb24gbWFya0l0ZW0obWFya1R5cGUsIG9wdGlvbnMpIHtcbiAgICBjb25zdCBwYXNzZWRPcHRpb25zID0ge1xuICAgICAgICBhY3RpdmUoc3RhdGUpIHtcbiAgICAgICAgICAgIHJldHVybiBtYXJrQWN0aXZlKHN0YXRlLCBtYXJrVHlwZSk7XG4gICAgICAgIH0sXG4gICAgICAgIGVuYWJsZTogdHJ1ZSxcbiAgICB9O1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpmb3JpblxuICAgIGZvciAoY29uc3QgcHJvcCBpbiBvcHRpb25zKSB7XG4gICAgICAgIHBhc3NlZE9wdGlvbnNbcHJvcF0gPSBvcHRpb25zW3Byb3BdO1xuICAgIH1cbiAgICByZXR1cm4gY21kSXRlbSh0b2dnbGVNYXJrKG1hcmtUeXBlKSwgcGFzc2VkT3B0aW9ucyk7XG59XG5cbmZ1bmN0aW9uIHdyYXBMaXN0SXRlbShub2RlVHlwZSwgb3B0aW9ucykge1xuICAgIHJldHVybiBjbWRJdGVtKHdyYXBJbkxpc3Qobm9kZVR5cGUsIG9wdGlvbnMuYXR0cnMpLCBvcHRpb25zKTtcbn1cblxuLy8gOjogKFNjaGVtYSkg4oaSIE9iamVjdFxuLy8gR2l2ZW4gYSBzY2hlbWEsIGxvb2sgZm9yIGRlZmF1bHQgbWFyayBhbmQgbm9kZSB0eXBlcyBpbiBpdCBhbmRcbi8vIHJldHVybiBhbiBvYmplY3Qgd2l0aCByZWxldmFudCBtZW51IGl0ZW1zIHJlbGF0aW5nIHRvIHRob3NlIG1hcmtzOlxuLy9cbi8vICoqYHRvZ2dsZVN0cm9uZ2AqKmA6IE1lbnVJdGVtYFxuLy8gICA6IEEgbWVudSBpdGVtIHRvIHRvZ2dsZSB0aGUgW3N0cm9uZyBtYXJrXSgjc2NoZW1hLWJhc2ljLlN0cm9uZ01hcmspLlxuLy9cbi8vICoqYHRvZ2dsZUVtYCoqYDogTWVudUl0ZW1gXG4vLyAgIDogQSBtZW51IGl0ZW0gdG8gdG9nZ2xlIHRoZSBbZW1waGFzaXMgbWFya10oI3NjaGVtYS1iYXNpYy5FbU1hcmspLlxuLy9cbi8vICoqYHRvZ2dsZUNvZGVgKipgOiBNZW51SXRlbWBcbi8vICAgOiBBIG1lbnUgaXRlbSB0byB0b2dnbGUgdGhlIFtjb2RlIGZvbnQgbWFya10oI3NjaGVtYS1iYXNpYy5Db2RlTWFyaykuXG4vL1xuLy8gKipgdG9nZ2xlTGlua2AqKmA6IE1lbnVJdGVtYFxuLy8gICA6IEEgbWVudSBpdGVtIHRvIHRvZ2dsZSB0aGUgW2xpbmsgbWFya10oI3NjaGVtYS1iYXNpYy5MaW5rTWFyaykuXG4vL1xuLy8gKipgaW5zZXJ0SW1hZ2VgKipgOiBNZW51SXRlbWBcbi8vICAgOiBBIG1lbnUgaXRlbSB0byBpbnNlcnQgYW4gW2ltYWdlXSgjc2NoZW1hLWJhc2ljLkltYWdlKS5cbi8vXG4vLyAqKmB3cmFwQnVsbGV0TGlzdGAqKmA6IE1lbnVJdGVtYFxuLy8gICA6IEEgbWVudSBpdGVtIHRvIHdyYXAgdGhlIHNlbGVjdGlvbiBpbiBhIFtidWxsZXQgbGlzdF0oI3NjaGVtYS1saXN0LkJ1bGxldExpc3QpLlxuLy9cbi8vICoqYHdyYXBPcmRlcmVkTGlzdGAqKmA6IE1lbnVJdGVtYFxuLy8gICA6IEEgbWVudSBpdGVtIHRvIHdyYXAgdGhlIHNlbGVjdGlvbiBpbiBhbiBbb3JkZXJlZCBsaXN0XSgjc2NoZW1hLWxpc3QuT3JkZXJlZExpc3QpLlxuLy9cbi8vICoqYHdyYXBCbG9ja1F1b3RlYCoqYDogTWVudUl0ZW1gXG4vLyAgIDogQSBtZW51IGl0ZW0gdG8gd3JhcCB0aGUgc2VsZWN0aW9uIGluIGEgW2Jsb2NrIHF1b3RlXSgjc2NoZW1hLWJhc2ljLkJsb2NrUXVvdGUpLlxuLy9cbi8vICoqYG1ha2VQYXJhZ3JhcGhgKipgOiBNZW51SXRlbWBcbi8vICAgOiBBIG1lbnUgaXRlbSB0byBzZXQgdGhlIGN1cnJlbnQgdGV4dGJsb2NrIHRvIGJlIGEgbm9ybWFsXG4vLyAgICAgW3BhcmFncmFwaF0oI3NjaGVtYS1iYXNpYy5QYXJhZ3JhcGgpLlxuLy9cbi8vICoqYG1ha2VDb2RlQmxvY2tgKipgOiBNZW51SXRlbWBcbi8vICAgOiBBIG1lbnUgaXRlbSB0byBzZXQgdGhlIGN1cnJlbnQgdGV4dGJsb2NrIHRvIGJlIGFcbi8vICAgICBbY29kZSBibG9ja10oI3NjaGVtYS1iYXNpYy5Db2RlQmxvY2spLlxuLy9cbi8vICoqYG1ha2VIZWFkW05dYCoqYDogTWVudUl0ZW1gXG4vLyAgIDogV2hlcmUgX05fIGlzIDEgdG8gNi4gTWVudSBpdGVtcyB0byBzZXQgdGhlIGN1cnJlbnQgdGV4dGJsb2NrIHRvXG4vLyAgICAgYmUgYSBbaGVhZGluZ10oI3NjaGVtYS1iYXNpYy5IZWFkaW5nKSBvZiBsZXZlbCBfTl8uXG4vL1xuLy8gKipgaW5zZXJ0SG9yaXpvbnRhbFJ1bGVgKipgOiBNZW51SXRlbWBcbi8vICAgOiBBIG1lbnUgaXRlbSB0byBpbnNlcnQgYSBob3Jpem9udGFsIHJ1bGUuXG4vL1xuLy8gVGhlIHJldHVybiB2YWx1ZSBhbHNvIGNvbnRhaW5zIHNvbWUgcHJlZmFicmljYXRlZCBtZW51IGVsZW1lbnRzIGFuZFxuLy8gbWVudXMsIHRoYXQgeW91IGNhbiB1c2UgaW5zdGVhZCBvZiBjb21wb3NpbmcgeW91ciBvd24gbWVudSBmcm9tXG4vLyBzY3JhdGNoOlxuLy9cbi8vICoqYGluc2VydE1lbnVgKipgOiBEcm9wZG93bmBcbi8vICAgOiBBIGRyb3Bkb3duIGNvbnRhaW5pbmcgdGhlIGBpbnNlcnRJbWFnZWAgYW5kXG4vLyAgICAgYGluc2VydEhvcml6b250YWxSdWxlYCBpdGVtcy5cbi8vXG4vLyAqKmB0eXBlTWVudWAqKmA6IERyb3Bkb3duYFxuLy8gICA6IEEgZHJvcGRvd24gY29udGFpbmluZyB0aGUgaXRlbXMgZm9yIG1ha2luZyB0aGUgY3VycmVudFxuLy8gICAgIHRleHRibG9jayBhIHBhcmFncmFwaCwgY29kZSBibG9jaywgb3IgaGVhZGluZy5cbi8vXG4vLyAqKmBmdWxsTWVudWAqKmA6IFtbTWVudUVsZW1lbnRdXWBcbi8vICAgOiBBbiBhcnJheSBvZiBhcnJheXMgb2YgbWVudSBlbGVtZW50cyBmb3IgdXNlIGFzIHRoZSBmdWxsIG1lbnVcbi8vICAgICBmb3IsIGZvciBleGFtcGxlIHRoZSBbbWVudSBiYXJdKGh0dHBzOi8vZ2l0aHViLmNvbS9wcm9zZW1pcnJvci9wcm9zZW1pcnJvci1tZW51I3VzZXItY29udGVudC1tZW51YmFyKS5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZE1lbnVJdGVtcyhzY2hlbWE6IFNjaGVtYSwgbW9kYWxTZXJ2aWNlOiBNb2RhbFNlcnZpY2UpIHtcbiAgICBjb25zdCByOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG4gICAgbGV0IHR5cGU6IE1hcmtUeXBlIHwgTm9kZVR5cGU7XG4gICAgLy8gdHNsaW50OmRpc2FibGU6bm8tY29uZGl0aW9uYWwtYXNzaWdubWVudFxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5tYXJrcy5zdHJvbmcpKSB7XG4gICAgICAgIHIudG9nZ2xlU3Ryb25nID0gbWFya0l0ZW0odHlwZSwgeyB0aXRsZTogJ1RvZ2dsZSBzdHJvbmcgc3R5bGUnLCBpY29uOiBpY29ucy5zdHJvbmcgfSk7XG4gICAgfVxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5tYXJrcy5lbSkpIHtcbiAgICAgICAgci50b2dnbGVFbSA9IG1hcmtJdGVtKHR5cGUsIHsgdGl0bGU6ICdUb2dnbGUgZW1waGFzaXMnLCBpY29uOiBpY29ucy5lbSB9KTtcbiAgICB9XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm1hcmtzLmNvZGUpKSB7XG4gICAgICAgIHIudG9nZ2xlQ29kZSA9IG1hcmtJdGVtKHR5cGUsIHsgdGl0bGU6ICdUb2dnbGUgY29kZSBmb250JywgaWNvbjogaWNvbnMuY29kZSB9KTtcbiAgICB9XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm1hcmtzLmxpbmspKSB7XG4gICAgICAgIHIudG9nZ2xlTGluayA9IGxpbmtJdGVtKHR5cGUsIG1vZGFsU2VydmljZSk7XG4gICAgfVxuXG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLmltYWdlKSkge1xuICAgICAgICByLmluc2VydEltYWdlID0gaW5zZXJ0SW1hZ2VJdGVtKHR5cGUsIG1vZGFsU2VydmljZSk7XG4gICAgfVxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5idWxsZXRfbGlzdCkpIHtcbiAgICAgICAgci53cmFwQnVsbGV0TGlzdCA9IHdyYXBMaXN0SXRlbSh0eXBlLCB7XG4gICAgICAgICAgICB0aXRsZTogJ1dyYXAgaW4gYnVsbGV0IGxpc3QnLFxuICAgICAgICAgICAgaWNvbjogaWNvbnMuYnVsbGV0TGlzdCxcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5vcmRlcmVkX2xpc3QpKSB7XG4gICAgICAgIHIud3JhcE9yZGVyZWRMaXN0ID0gd3JhcExpc3RJdGVtKHR5cGUsIHtcbiAgICAgICAgICAgIHRpdGxlOiAnV3JhcCBpbiBvcmRlcmVkIGxpc3QnLFxuICAgICAgICAgICAgaWNvbjogaWNvbnMub3JkZXJlZExpc3QsXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMuYmxvY2txdW90ZSkpIHtcbiAgICAgICAgci53cmFwQmxvY2tRdW90ZSA9IHdyYXBJdGVtKHR5cGUsIHtcbiAgICAgICAgICAgIHRpdGxlOiAnV3JhcCBpbiBibG9jayBxdW90ZScsXG4gICAgICAgICAgICBpY29uOiBpY29ucy5ibG9ja3F1b3RlLFxuICAgICAgICB9KTtcbiAgICB9XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLnBhcmFncmFwaCkpIHtcbiAgICAgICAgci5tYWtlUGFyYWdyYXBoID0gYmxvY2tUeXBlSXRlbSh0eXBlLCB7XG4gICAgICAgICAgICB0aXRsZTogJ0NoYW5nZSB0byBwYXJhZ3JhcGgnLFxuICAgICAgICAgICAgbGFiZWw6ICdQbGFpbicsXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMuY29kZV9ibG9jaykpIHtcbiAgICAgICAgci5tYWtlQ29kZUJsb2NrID0gYmxvY2tUeXBlSXRlbSh0eXBlLCB7XG4gICAgICAgICAgICB0aXRsZTogJ0NoYW5nZSB0byBjb2RlIGJsb2NrJyxcbiAgICAgICAgICAgIGxhYmVsOiAnQ29kZScsXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMuaGVhZGluZykpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gMTA7IGkrKykge1xuICAgICAgICAgICAgclsnbWFrZUhlYWQnICsgaV0gPSBibG9ja1R5cGVJdGVtKHR5cGUsIHtcbiAgICAgICAgICAgICAgICB0aXRsZTogJ0NoYW5nZSB0byBoZWFkaW5nICcgKyBpLFxuICAgICAgICAgICAgICAgIGxhYmVsOiAnTGV2ZWwgJyArIGksXG4gICAgICAgICAgICAgICAgYXR0cnM6IHsgbGV2ZWw6IGkgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5ob3Jpem9udGFsX3J1bGUpKSB7XG4gICAgICAgIGNvbnN0IGhyID0gdHlwZTtcbiAgICAgICAgci5pbnNlcnRIb3Jpem9udGFsUnVsZSA9IG5ldyBNZW51SXRlbSh7XG4gICAgICAgICAgICB0aXRsZTogJ0luc2VydCBob3Jpem9udGFsIHJ1bGUnLFxuICAgICAgICAgICAgbGFiZWw6ICdIb3Jpem9udGFsIHJ1bGUnLFxuICAgICAgICAgICAgY2xhc3M6ICcnLFxuICAgICAgICAgICAgY3NzOiAnJyxcbiAgICAgICAgICAgIGVuYWJsZShzdGF0ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBjYW5JbnNlcnQoc3RhdGUsIGhyKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBydW4oc3RhdGU6IEVkaXRvclN0YXRlLCBkaXNwYXRjaCkge1xuICAgICAgICAgICAgICAgIGRpc3BhdGNoKHN0YXRlLnRyLnJlcGxhY2VTZWxlY3Rpb25XaXRoKGhyLmNyZWF0ZSgpKSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBjdXQgPSA8VD4oYXJyOiBUW10pOiBUW10gPT4gYXJyLmZpbHRlcih4ID0+IHgpO1xuICAgIHIuaW5zZXJ0TWVudSA9IG5ldyBEcm9wZG93bihjdXQoW3IuaW5zZXJ0SW1hZ2UsIHIuaW5zZXJ0SG9yaXpvbnRhbFJ1bGVdKSwgeyBsYWJlbDogJ0luc2VydCcgfSk7XG4gICAgci50eXBlTWVudSA9IG5ldyBEcm9wZG93bihcbiAgICAgICAgY3V0KFtcbiAgICAgICAgICAgIHIubWFrZVBhcmFncmFwaCxcbiAgICAgICAgICAgIHIubWFrZUNvZGVCbG9jayxcbiAgICAgICAgICAgIHIubWFrZUhlYWQxICYmXG4gICAgICAgICAgICAgICAgbmV3IERyb3Bkb3duU3VibWVudShcbiAgICAgICAgICAgICAgICAgICAgY3V0KFtyLm1ha2VIZWFkMSwgci5tYWtlSGVhZDIsIHIubWFrZUhlYWQzLCByLm1ha2VIZWFkNCwgci5tYWtlSGVhZDUsIHIubWFrZUhlYWQ2XSksXG4gICAgICAgICAgICAgICAgICAgIHsgbGFiZWw6ICdIZWFkaW5nJyB9LFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgIF0pLFxuICAgICAgICB7IGxhYmVsOiAnVHlwZS4uLicgfSxcbiAgICApO1xuXG4gICAgY29uc3QgaW5saW5lTWVudSA9IGN1dChbci50b2dnbGVTdHJvbmcsIHIudG9nZ2xlRW0sIHIudG9nZ2xlTGlua10pO1xuICAgIHIuaW5saW5lTWVudSA9IFtpbmxpbmVNZW51XTtcbiAgICByLmJsb2NrTWVudSA9IFtcbiAgICAgICAgY3V0KFtcbiAgICAgICAgICAgIHIud3JhcEJ1bGxldExpc3QsXG4gICAgICAgICAgICByLndyYXBPcmRlcmVkTGlzdCxcbiAgICAgICAgICAgIHIud3JhcEJsb2NrUXVvdGUsXG4gICAgICAgICAgICBqb2luVXBJdGVtLFxuICAgICAgICAgICAgbGlmdEl0ZW0sXG4gICAgICAgICAgICBzZWxlY3RQYXJlbnROb2RlSXRlbSxcbiAgICAgICAgXSksXG4gICAgXTtcbiAgICByLmZ1bGxNZW51ID0gW2lubGluZU1lbnVdLmNvbmNhdChbW3IuaW5zZXJ0TWVudSwgci50eXBlTWVudV1dLCBbW3VuZG9JdGVtLCByZWRvSXRlbV1dLCByLmJsb2NrTWVudSk7XG5cbiAgICByZXR1cm4gcjtcbn1cbiJdfQ==